machine:
  services:
    - docker
  environment:
    MIN_CIRCLE_NODES: 4
  post:
    - if (( $CIRCLE_NODE_TOTAL < $MIN_CIRCLE_NODES )); then echo "Build requires at least $MIN_CIRCLE_NODES nodes, was ${CIRCLE_NODE_TOTAL}"; false; fi

test:
  override:
    - ? |
        case $CIRCLE_NODE_INDEX in
          0)
            cd ~/$CIRCLE_PROJECT_REPONAME/alpine-go-1.6 && docker build . && \
            cd ~/$CIRCLE_PROJECT_REPONAME/alpine-go-1.7.5 && docker build . && \
            cd ~/$CIRCLE_PROJECT_REPONAME/alpine-go-1.8.0 && docker build .
            ;;
          1)
            cd ~/$CIRCLE_PROJECT_REPONAME/alpine-go-1.7-1.8 && docker build .
            ;;
          2)
            cd ~/$CIRCLE_PROJECT_REPONAME/go-1.7-1.8 && docker build . && \
            cd ~/$CIRCLE_PROJECT_REPONAME/go-1.8-rpm-fpm && docker build .
            ;;
          3)
            cd ~/$CIRCLE_PROJECT_REPONAME/brew-go && docker build .
            ;;
          *)
            echo "Unexpected node $CIRCLE_NODE_INDEX"
            ;;
        esac
      :
          parallel: true
